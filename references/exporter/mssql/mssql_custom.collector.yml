##################################################################################################################################
### Custom SQL Server Metrics For SDS Cloud  #####################################################################################
### YeonHong.Min 2025.02.19 CI-TEC           #####################################################################################
##################################################################################################################################

collector_name: mssql_custom

# Similar to global.min_interval, but applies to the queries defined by this collector only.
#min_interval: 0s

metrics:
  - metric_name: mssql_local_time_seconds
    type: gauge
    help: 'Local time in seconds since epoch (Unix time).'
    values: [unix_time]
    query: |
      SELECT DATEDIFF(second, '19700101', GETUTCDATE()) AS unix_time;

  - metric_name: mssql_connections
    type: gauge
    help: 'Number of active connections.'
    key_labels:
      - db
    values: [count]
    query: |
      SELECT db.name AS db, COUNT(sp.spid) AS count
      FROM sys.sysprocesses sp
      INNER JOIN sys.databases db ON db.database_id = sp.dbid
      GROUP BY db.name;

  #
  # Collected from sys.dm_os_performance_counters
  #
  - metric_name: mssql_deadlocks
    type: counter
    help: 'Number of lock requests that resulted in a deadlock.'
    values: [cntr_value]
    query: |
      SELECT cntr_value
      FROM sys.dm_os_performance_counters WITH (NOLOCK)
      WHERE counter_name = 'Number of Deadlocks/sec' AND instance_name = '_Total';

  - metric_name: mssql_user_errors
    type: counter
    help: 'Number of user errors.'
    values: [cntr_value]
    query: |
      SELECT cntr_value
      FROM sys.dm_os_performance_counters WITH (NOLOCK)
      WHERE counter_name = 'Errors/sec' AND instance_name = 'User Errors';

  - metric_name: mssql_kill_connection_errors
    type: counter
    help: 'Number of severe errors that caused SQL Server to kill the connection.'
    values: [cntr_value]
    query: |
      SELECT cntr_value
      FROM sys.dm_os_performance_counters WITH (NOLOCK)
      WHERE counter_name = 'Errors/sec' AND instance_name = 'Kill Connection Errors';

  - metric_name: mssql_page_life_expectancy_seconds
    type: gauge
    help: 'The minimum number of seconds a page will stay in the buffer pool on this node without references.'
    values: [cntr_value]
    query: |
      SELECT top(1) cntr_value
      FROM sys.dm_os_performance_counters WITH (NOLOCK)
      WHERE counter_name = 'Page life expectancy';

  - metric_name: mssql_batch_requests
    type: counter
    help: 'Number of command batches received.'
    values: [cntr_value]
    query: |
      SELECT cntr_value
      FROM sys.dm_os_performance_counters WITH (NOLOCK)
      WHERE counter_name = 'Batch Requests/sec';

  - metric_name: mssql_log_growths
    type: counter
    help: 'Number of times the transaction log has been expanded, per database.'
    key_labels:
      - db
    values: [cntr_value]
    query: |
      SELECT rtrim(instance_name) AS db, cntr_value
      FROM sys.dm_os_performance_counters WITH (NOLOCK)
      WHERE counter_name = 'Log Growths' AND instance_name <> '_Total';

  #
  # Collected from sys.dm_io_virtual_file_stats
  #
  - metric_name: mssql_io_stall_seconds
    type: counter
    help: 'Stall time in seconds per database and I/O operation.'
    key_labels:
      - db
    value_label: operation
    values:
      - read
      - write
    query_ref: mssql_io_stall

  - metric_name: mssql_io_stall_total_seconds
    type: counter
    help: 'Total stall time in seconds per database.'
    key_labels:
      - db
    values:
      - io_stall
    query_ref: mssql_io_stall

  #
  # Collected from sys.dm_os_process_memory
  #
  - metric_name: mssql_resident_memory_bytes
    type: gauge
    help: 'SQL Server resident memory size (AKA working set).'
    values: [resident_memory_bytes]
    query_ref: mssql_process_memory

  - metric_name: mssql_virtual_memory_bytes
    type: gauge
    help: 'SQL Server committed virtual memory size.'
    values: [virtual_memory_bytes]
    query_ref: mssql_process_memory

  - metric_name: mssql_memory_utilization_percentage
    type: gauge
    help: 'The percentage of committed memory that is in the working set.'
    values: [memory_utilization_percentage]
    query_ref: mssql_process_memory

  - metric_name: mssql_page_fault_count
    type: counter
    help: 'The number of page faults that were incurred by the SQL Server process.'
    values: [page_fault_count]
    query_ref: mssql_process_memory

  #
  # Collected from sys.dm_os_sys_memory
  #
  - metric_name: mssql_os_memory
    type: gauge
    help: 'OS physical memory, used and available.'
    value_label: 'state'
    values: [total, used, available, pct]
    query: |
      SELECT
        total_physical_memory_kb * 1024 AS total,
        (total_physical_memory_kb - available_physical_memory_kb) * 1024 AS used,
        available_physical_memory_kb * 1024 AS available,
        (100 * (total_physical_memory_kb - available_physical_memory_kb) / total_physical_memory_kb) AS pct
      FROM sys.dm_os_sys_memory

  - metric_name: mssql_info
    type: gauge
    help: 'virtual_machine_type, cpu_count, socket_count, cores_per_socket, numa_node_count'
    key_labels:
      - virtual_machine_type
      - productversion
      - productlevel
      - edition
      - engineedition
    value_label: 'info'
    values: [cpu_count, socket_count, cores_per_socket, hyperthread_ratio, numa_node_count]
    query: |
      SELECT cpu_count
           , socket_count
           , cores_per_socket
           , hyperthread_ratio
           , numa_node_count
           , virtual_machine_type_desc as virtual_machine_type
           , SERVERPROPERTY('ProductVersion') AS productversion
           , SERVERPROPERTY('ProductLevel')   AS productlevel
           , SERVERPROPERTY('Edition')        AS edition
           , SERVERPROPERTY('EngineEdition')  AS engineedition
        FROM sys.dm_os_sys_info
       WHERE DATEPART(MINUTE, SYSDATETIME()) = 0
         AND DATEPART(SECOND, SYSDATETIME()) between 0 and 15

  - metric_name: mssql_parameters
    type: gauge
    help: 'configurations'
    key_labels:
      - name
      - description
    value_label: 'state'
    values: [value, value_in_use]
    query: |
      SELECT name, value, value_in_use, description
        FROM sys.configurations
       WHERE DATEPART(MINUTE, SYSDATETIME()) = 0
         AND DATEPART(SECOND, SYSDATETIME()) between 0 and 15

  - metric_name: mssql_uptime
    type: gauge
    help: 'uptime in seconds'
    values: [uptime_sec]
    query: |
      SELECT DATEDIFF(SECOND, sqlserver_start_time, GETDATE()) AS uptime_sec
        FROM sys.dm_os_sys_info

  - metric_name: mssql_os_page_file
    type: gauge
    help: 'OS page file, used and available.'
    value_label: 'state'
    values: [used, available]
    query: |
      SELECT
        (total_page_file_kb - available_page_file_kb) * 1024 AS used,
        available_page_file_kb * 1024 AS available
      FROM sys.dm_os_sys_memory

  - metric_name: mssql_clerk_size_kilobytes
    type: gauge
    help: 'Memory Clerk'
    key_labels:
      - clerk_type
    values: [size_kb]
    query_ref: mssql_clerk

  - metric_name: mssql_drive_size_gb
    type: gauge
    help: 'Drive Size Gb'
    key_labels:
      - drive
      - volume
    values: [totalgb]
    query_ref: mssql_drive_size

  - metric_name: mssql_drive_free_gb
    type: gauge
    help: 'Drive Free Gb'
    key_labels:
      - drive
      - volume
    values: [freegb]
    query_ref: mssql_drive_size

  - metric_name: mssql_drive_free_pct
    type: gauge
    help: 'Drive Free PCT'
    key_labels:
      - drive
      - volume
    values: [freepct]
    query_ref: mssql_drive_size

  - metric_name: mssql_drive_used_pct
    type: gauge
    help: 'Drive Used PCT'
    key_labels:
      - drive
      - volume
    values: [usedpct]
    query_ref: mssql_drive_size

  - metric_name: mssql_file_size_bytes
    type: gauge
    help: 'Database Size in Bytes'
    key_labels:
      - database
      - file_type
      - mount_point
      - file_name
    values: [size_bytes]
    query_ref: mssql_file_size

  - metric_name: mssql_file_growth
    type: gauge
    help: 'growth of files'
    key_labels:
      - database
      - file_type
      - mount_point
      - file_name
    values: [growth]
    query_ref: mssql_file_size

  - metric_name: mssql_file_max_pages
    type: gauge
    help: 'max size(pages) of files'
    key_labels:
      - database
      - file_type
      - mount_point
      - file_name
    values: [max_size_pages]
    query_ref: mssql_file_size


  - metric_name: mssql_wait_time_seconds
    type: gauge
    help: 'Wait Time in Seconds'
    key_labels:
      - wait_type
      - wait_category
    values: [wait_time_seconds]
    query_ref: mssql_wait

  - metric_name: mssql_signal_wait_time_seconds
    type: gauge
    help: 'Signal Wait Time in Seconds'
    key_labels:
      - wait_type
      - wait_category
    values: [signal_wait_time_seconds]
    query_ref: mssql_wait

  - metric_name: mssql_waiting_tasks_count
    type: gauge
    help: 'Wait Tasks Count'
    key_labels:
      - wait_type
      - wait_category
    values: [waiting_tasks_count]
    query_ref: mssql_wait

  - metric_name: mssql_perf_counter
    type: counter
    help: 'Performance counters'
    key_labels:
      - db
      - object
      - counter
    values: [counter_value]
    query_ref: mssql_performance_counters

  - metric_name: mssql_perf_gauge
    type: gauge
    help: 'Performance gauges'
    key_labels:
      - db
      - object
      - gauge
    values: [counter_value]
    query_ref: mssql_performance_gauges

  - metric_name: mssql_sess_wtime_sec
    type: gauge
    help: 'Session Waits'
    key_labels:
      - username
      - session_id
      - blocking_session_id
      - hostname
      - program
      - start_time
      - status
      - command
      - db
      - wait_type
      - last_wait_type
      - wait_resource
      - open_transaction_count
      - transaction_id
      - percent_complete
      - estimated_completion_time
      - cpu_time
      - elapsed_sec
      - physical_read_mb
      - physical_write_mb
      - physical_io_mb
      - used_menory_kb
      - logical_reads
      - transaction_isolation_level
      - row_count
      - granted_query_memory
      - sql_handle
      - statement_text
    values: [wait_time_ms]
    query_ref: mssql_sess

  - metric_name: mssql_top_exec_sql
    type: counter
    help: 'execution_count'
    key_labels:
      - db
      - sql_handle
      - plan_handle
      - statement_start_offset
    values: [execution_count]
    query_ref: mssql_sqls

  - metric_name: mssql_top_cpu_sql
    type: counter
    help: 'total_cpu_time_ms'
    key_labels:
      - db
      - sql_handle
      - plan_handle
      - statement_start_offset
    values: [total_cpu_time_ms]
    query_ref: mssql_sqls

  - metric_name: mssql_top_elapsed_sql
    type: counter
    help: 'total_elapsed_time_ms'
    key_labels:
      - db
      - sql_handle
      - plan_handle
      - statement_start_offset
      - partial_query
    values: [total_elapsed_time_ms]
    query_ref: mssql_sqls

  - metric_name: mssql_top_logical_read_sql
    type: counter
    help: 'total_logical_reads'
    key_labels:
      - db
      - sql_handle
      - plan_handle
      - statement_start_offset
    values: [total_logical_reads]
    query_ref: mssql_sqls

  - metric_name: mssql_top_logical_writes_sql
    type: counter
    help: 'total_logical_writes'
    key_labels:
      - db
      - sql_handle
      - plan_handle
      - statement_start_offset
    values: [total_logical_writes]
    query_ref: mssql_sqls

  - metric_name: mssql_top_physical_read_sql
    type: counter
    help: 'total_physical_reads'
    key_labels:
      - db
      - sql_handle
      - plan_handle
      - statement_start_offset
    values: [total_physical_reads]
    query_ref: mssql_sqls

queries:
  # Populates `mssql_io_stall` and `mssql_io_stall_total`
  - query_name: mssql_io_stall
    query: |
      SELECT
        cast(DB_Name(a.database_id) as varchar) AS [db],
        sum(io_stall_read_ms) / 1000.0 AS [read],
        sum(io_stall_write_ms) / 1000.0 AS [write],
        sum(io_stall) / 1000.0 AS io_stall
      FROM
        sys.dm_io_virtual_file_stats(null, null) a
      INNER JOIN sys.master_files b ON a.database_id = b.database_id AND a.file_id = b.file_id
      GROUP BY a.database_id;

  # Populates `mssql_resident_memory_bytes`, `mssql_virtual_memory_bytes`, `mssql_memory_utilization_percentage` and
  # `mssql_page_fault_count`.
  - query_name: mssql_process_memory
    query: |
      SELECT
        physical_memory_in_use_kb * 1024 AS resident_memory_bytes,
        virtual_address_space_committed_kb * 1024 AS virtual_memory_bytes,
        memory_utilization_percentage,
        page_fault_count
      FROM sys.dm_os_process_memory;

  - query_name: mssql_clerk
    query: |
      SELECT
              mc.[type] AS [clerk_type]
              ,SUM(mc.[pages_kb]) AS [size_kb]
      FROM sys.[dm_os_memory_clerks] AS mc WITH (NOLOCK)
      GROUP BY
               mc.[type]
      HAVING
              SUM(mc.[pages_kb]) >= 1024
      OPTION(RECOMPILE);

  - query_name: mssql_drive_size
    query: |
      SELECT DISTINCT
        vs.volume_mount_point AS [drive]
      , vs.logical_volume_name AS [volume]
      , vs.total_bytes/1024/1024/1024 AS [totalgb]
      , vs.available_bytes/1024/1024/1024 AS [freegb]
      , CAST(vs.available_bytes * 100. / vs.total_bytes AS DECIMAL(4,1)) as [freepct]
      , 100-CAST(vs.available_bytes * 100. / vs.total_bytes AS DECIMAL(4,1)) as [usedpct]
      FROM (select *
              from sys.master_files WITH (NOLOCK)
             WHERE DATEPART(MINUTE, SYSDATETIME()) = 0
               AND DATEPART(SECOND, SYSDATETIME()) between 0 and 15) mf
          CROSS APPLY
        sys.dm_os_volume_stats(mf.database_id, mf.file_id) AS vs;

  - query_name: mssql_file_size
    query: |
      SELECT DB_NAME(mf.database_id)        AS [database]
           , CASE WHEN type_desc = 'LOG' THEN 'Log File' WHEN type_desc = 'ROWS' THEN 'Data File' ELSE type_desc END AS [file_type]
           , LEFT(mf.physical_name, CHARINDEX('\',mf.physical_name))  AS [mount_point]
           , mf.physical_name               AS [file_name]
           , divfs.size_on_disk_bytes       AS [size_bytes]
           , mf.growth                      AS [growth]
           , mf.max_size                    AS [max_size_pages]
        FROM sys.dm_io_virtual_file_stats(NULL, NULL) AS divfs
        JOIN sys.master_files AS mf WITH (NOLOCK)
          ON mf.database_id = divfs.database_id
         AND mf.file_id = divfs.file_id
       WHERE DB_NAME(mf.database_id) NOT IN ('master', 'model','tempdb', 'msdb')
         AND DATEPART(MINUTE, SYSDATETIME()) = 0
         AND DATEPART(SECOND, SYSDATETIME()) between 0 and 15;


  - query_name: mssql_performance_counters
    query: |
      DECLARE @PCounters TABLE
      (
          [object_name] nvarchar(128),
          [counter_name] nvarchar(128),
          [instance_name] nvarchar(128),
          [cntr_value] bigint,
          [cntr_type] INT ,
          Primary Key([object_name],[counter_name],[instance_name])
      );
      WITH PerfCounters AS (
          SELECT DISTINCT
           RTrim(spi.[object_name]) [object_name]
          ,RTrim(spi.[counter_name]) [counter_name]
          ,CASE WHEN (
                 RTRIM(spi.[object_name]) LIKE '%:Databases'
              OR RTRIM(spi.[object_name]) LIKE '%:Database Replica'
              OR RTRIM(spi.[object_name]) LIKE '%:Catalog Metadata'
              OR RTRIM(spi.[object_name]) LIKE '%:Query Store'
              OR RTRIM(spi.[object_name]) LIKE '%:Columnstore'
              OR RTRIM(spi.[object_name]) LIKE '%:Advanced Analytics')
              AND TRY_CONVERT([uniqueidentifier], spi.[instance_name]) IS NOT NULL
                  THEN ISNULL(d.[name],RTRIM(spi.instance_name))
              WHEN
                  RTRIM([object_name]) LIKE '%:Availability Replica'
                  AND TRY_CONVERT([uniqueidentifier], spi.[instance_name]) IS NOT NULL
                      THEN ISNULL(d.[name],RTRIM(spi.[instance_name])) + RTRIM(SUBSTRING(spi.[instance_name], 37, LEN(spi.[instance_name])))
              ELSE RTRIM(spi.instance_name)
          END AS [instance_name]
          ,CAST(spi.[cntr_value] AS BIGINT) AS [cntr_value]
          ,spi.[cntr_type]
          FROM sys.dm_os_performance_counters AS spi
          LEFT JOIN sys.databases AS d
              ON LEFT(spi.[instance_name], 36)
              = CASE
                  WHEN d.[name] = 'master' AND TRY_CONVERT([uniqueidentifier], d.[name]) IS NOT NULL
                      THEN d.[name]
                  ELSE d.[name]
              END
          WHERE
              counter_name IN (
                  -- following are all counters
                  -- from Databases object
                  'Transactions/sec'
                  ,'Log Bytes Flushed/sec'
                  ,'Log Flushes/sec'
                  ,'Log Flush Write Time (ms)'
                  -- from SQL Statistics object
                  ,'Batch Requests/sec'
                  ,'SQL Compilations/sec'
                  ,'SQL Re-Compilations/sec'
                  -- from General Statistics
                  ,'Temp Tables Creation Rate'
                  ,'Temp Tables For Destruction'
                  ,'Temp Tables Creation Rate'
                  ,'Logins/sec'
                  ,'Logouts/sec'
                  -- from Access Methods object
                  ,'Forwarded Records/sec'
                  ,'Full Scans/sec'
                  ,'Index Searches/sec'
                  ,'Page Splits/sec'
                  ,'Table Lock Escalations/sec'
                  ,'Workfiles Created/sec'
                  ,'Worktables Created/sec'
                  ,'Mixed page allocations/sec'
                  ,'Extents Allocated/sec'
                  ,'Range Scans/sec'
                  -- Replication
                  ,'Bytes Sent to Replica/sec'
                  ,'Bytes Sent to Transport/sec'
                  ,'Sends to Replica/sec'
                  ,'Sends to Transport/sec'
                  -- from Buffer Manager
                  ,'Free list stalls/sec'
                  ,'Lazy writes/sec'
                  ,'Page lookups/sec'
                  ,'Page reads/sec'
                  ,'Page writes/sec'
                  ,'Readahead pages/sec'
                  ,'Checkpoint pages/sec'
                  ,'Background writer pages/sec'
                  -- Locks
                  ,'Lock Requests/sec'
                  ,'Lock Timeouts/sec'
                  ,'Lock Waits/sec'
                  ,'Lock Wait Time (ms)'
                  -- Latches
                  ,'Latch Waits/sec'
                  -- Cursor
                  ,'Cursor Requests/sec'
                  -- Transactions
                  ,'Pages/sec'
                  -- Network
                  ,'Page IO latch waits'
              )
      )
      INSERT INTO @PCounters select * from PerfCounters
      SELECT
          pc.[object_name] AS [object]
          ,pc.[counter_name] AS [counter]
          ,ISNULL(pc.[instance_name],'') AS [db]
          ,pc.[cntr_value] AS [counter_value]
      from @PCounters pc
      OPTION (RECOMPILE);

  - query_name: mssql_performance_gauges
    query: |
      SET DEADLOCK_PRIORITY -10;

      DECLARE @PCounters TABLE
      (
          [object_name] nvarchar(128),
          [counter_name] nvarchar(128),
          [instance_name] nvarchar(128),
          [cntr_value] bigint,
          [cntr_type] INT ,
          Primary Key([object_name],[counter_name],[instance_name])
      );
      WITH PerfCounters AS (
          SELECT DISTINCT
           RTrim(spi.[object_name]) [object_name]
          ,RTrim(spi.[counter_name]) [counter_name]
          ,CASE WHEN (
                 RTRIM(spi.[object_name]) LIKE '%:Databases'
              OR RTRIM(spi.[object_name]) LIKE '%:Database Replica'
              OR RTRIM(spi.[object_name]) LIKE '%:Buffer Manager'
              OR RTRIM(spi.[object_name]) LIKE '%:Buffer Node'
              OR RTRIM(spi.[object_name]) LIKE '%:Catalog Metadata'
              OR RTRIM(spi.[object_name]) LIKE '%:Query Store'
              OR RTRIM(spi.[object_name]) LIKE '%:Columnstore'
              OR RTRIM(spi.[object_name]) LIKE '%:Advanced Analytics')
              AND TRY_CONVERT([uniqueidentifier], spi.[instance_name]) IS NOT NULL
                  THEN ISNULL(d.[name],RTRIM(spi.instance_name))
              WHEN
                  RTRIM([object_name]) LIKE '%:Availability Replica'
                  AND TRY_CONVERT([uniqueidentifier], spi.[instance_name]) IS NOT NULL
                      THEN ISNULL(d.[name],RTRIM(spi.[instance_name])) + RTRIM(SUBSTRING(spi.[instance_name], 37, LEN(spi.[instance_name])))
              ELSE RTRIM(spi.instance_name)
          END AS [instance_name]
          ,CAST(spi.[cntr_value] AS BIGINT) AS [cntr_value]
          ,spi.[cntr_type]
          FROM sys.dm_os_performance_counters AS spi
          LEFT JOIN sys.databases AS d
              ON LEFT(spi.[instance_name], 36)
              = CASE
                  WHEN d.[name] = 'master' AND TRY_CONVERT([uniqueidentifier], d.[name]) IS NOT NULL
                      THEN d.[name]
                  ELSE d.[name]
              END
          WHERE
              counter_name IN (
                  -- following are all gauges
                  -- from Resource Pool Stats/Workload Group Stats objects
                   'CPU usage %'
                  ,'CPU usage % base'
                  ,'Active Transactions'
                  ,'Active parallel threads'
                  ,'Disk Read Bytes/sec'
                  ,'Disk Read IO/sec'
                  ,'Disk Read IO Throttled/sec'
                  ,'Disk Write Bytes/sec'
                  ,'Disk Write IO Throttled/sec'
                  ,'Disk Write IO/sec'
                  ,'Avg Disk Read IO (ms)'
                  ,'Avg Disk Read IO (ms) Base'
                  ,'Avg Disk Write IO (ms)'
                  ,'Avg Disk Write IO (ms) Base'
                  -- from General Statistics
                  ,'Active Temp Tables'
                  ,'Logical Connections'
                  ,'Processes blocked'
                  ,'User Connections'
                  -- from Memory Manager object
                  ,'Memory Grants Outstanding'
                  ,'Memory Grants Pending'
                  ,'Target Server Memory (KB)'
                  ,'Total Server Memory (KB)'
                  -- from Buffer Manager
                  ,'Page life expectancy'
                  ,'Extension free pages'
                  -- Latches
                  ,'Average Latch Wait Time (ms)'
                  ,'Average Latch Wait Time Base'
                  ,'Buffer cache hit ratio'
                  ,'Buffer cache hit ratio base'
                  -- Catalog metadata
                  ,'Cache Hit Ratio'
                  ,'Cache Hit Ratio Base'
                  -- Locks
                  ,'Lock Waits'
                  ,'Average Wait Time (ms)'
                  ,'Average Wait Time Base'
                  -- Cursor
                  ,'Cursor worktable usage'
                  -- Memory Manager
                  ,'Connection Memory'
                  ,'Lock Memory (KB)'
                  ,'Lock Blocks'
                  ,'Granted Workspace Memory (KB)'
                  ,'Optimizer Memory (KB)'
                  ,'SQL Cache Memory (KB)'
                  -- Transactions
                  ,'Free Space in tempdb (KB)'
                  ,'Version Store Size (KB)'
                  -- Network
                  ,'Network IO waits'
              )
      )
      INSERT INTO @PCounters select * from PerfCounters
      SELECT
          pc.[object_name] AS [object]
          ,pc.[counter_name] AS [gauge]
          ,ISNULL(pc.[instance_name],'') AS [db]
          ,CAST(CASE WHEN pc.[cntr_type] = 537003264 AND pc1.[cntr_value] > 0 THEN (pc.[cntr_value] * 1.0) / (pc1.[cntr_value] * 1.0) * 100 ELSE pc.[cntr_value] END AS float(10)) AS [counter_value]
      from @PCounters pc
      LEFT OUTER JOIN @PCounters AS pc1
          ON (
              pc.[counter_name] = REPLACE(pc1.[counter_name],' base','')
              OR pc.[counter_name] = REPLACE(pc1.[counter_name],' base',' (ms)')
          )
          AND pc.[object_name] = pc1.[object_name]
          AND pc.[instance_name] = pc1.[instance_name]
          AND pc1.[counter_name] LIKE '%base'
      WHERE
          pc.[counter_name] NOT LIKE '% base'
      OPTION (RECOMPILE);

  - query_name: mssql_wait
    query: |
      SELECT
        ws.[wait_type]
        ,CAST([wait_time_ms] / 1000.0 AS FLOAT(10)) AS [wait_time_seconds]
        --,[wait_time_ms] - [signal_wait_time_ms] AS [resource_wait_ms]
        ,CAST([signal_wait_time_ms] / 1000.0 AS FLOAT(10)) AS [signal_wait_time_seconds]
        -- ,[max_wait_time_ms]
        ,[waiting_tasks_count]
        ,CASE
        WHEN ws.[wait_type] LIKE 'SOS_SCHEDULER_YIELD' then 'CPU'
        WHEN ws.[wait_type] = 'THREADPOOL' THEN 'Worker Thread'
        WHEN ws.[wait_type] LIKE 'LCK[_]%' THEN 'Lock'
        WHEN ws.[wait_type] LIKE 'LATCH[_]%' THEN 'Latch'
        WHEN ws.[wait_type] LIKE 'PAGELATCH[_]%' THEN 'Buffer Latch'
        WHEN ws.[wait_type] LIKE 'PAGEIOLATCH[_]%' THEN 'Buffer IO'
        WHEN ws.[wait_type] LIKE 'RESOURCE_SEMAPHORE_QUERY_COMPILE%' THEN 'Compilation'
        WHEN ws.[wait_type] LIKE 'CLR[_]%' or ws.[wait_type] like 'SQLCLR%' THEN 'SQL CLR'
        WHEN ws.[wait_type] LIKE 'DBMIRROR_%' THEN 'Mirroring'
        WHEN ws.[wait_type] LIKE 'DTC[_]%' or ws.[wait_type] LIKE 'DTCNEW%' or ws.[wait_type] LIKE 'TRAN_%'
             or ws.[wait_type] LIKE 'XACT%' or ws.[wait_type] like 'MSQL_XACT%' THEN 'Transaction'
        WHEN ws.[wait_type] LIKE 'SLEEP[_]%'
            or ws.[wait_type] IN (
                'LAZYWRITER_SLEEP', 'SQLTRACE_BUFFER_FLUSH', 'SQLTRACE_INCREMENTAL_FLUSH_SLEEP',
                'SQLTRACE_WAIT_ENTRIES', 'FT_IFTS_SCHEDULER_IDLE_WAIT', 'XE_DISPATCHER_WAIT',
                'REQUEST_FOR_DEADLOCK_SEARCH', 'LOGMGR_QUEUE', 'ONDEMAND_TASK_QUEUE',
                'CHECKPOINT_QUEUE', 'XE_TIMER_EVENT') THEN 'Idle'
        WHEN ws.[wait_type] IN(
            'ASYNC_IO_COMPLETION','BACKUPIO','CHKPT','WRITE_COMPLETION',
            'IO_QUEUE_LIMIT', 'IO_RETRY') THEN 'Other Disk IO'
        WHEN ws.[wait_type] LIKE 'PREEMPTIVE_%' THEN 'Preemptive'
        WHEN ws.[wait_type] LIKE 'BROKER[_]%' THEN 'Service Broker'
        WHEN ws.[wait_type] IN (
            'WRITELOG','LOGBUFFER','LOGMGR_RESERVE_APPEND',
            'LOGMGR_FLUSH', 'LOGMGR_PMM_LOG')  THEN 'Tran Log IO'
        WHEN ws.[wait_type] LIKE 'LOG_RATE%' then 'Log Rate Governor'
        WHEN ws.[wait_type] LIKE 'HADR_THROTTLE[_]%'
            or ws.[wait_type] = 'THROTTLE_LOG_RATE_LOG_STORAGE' THEN 'HADR Log Rate Governor'
        WHEN ws.[wait_type] LIKE 'RBIO_RG%' or ws.[wait_type] like 'WAIT_RBIO_RG%' then 'VLDB Log Rate Governor'
        WHEN ws.[wait_type] LIKE 'RBIO[_]%' or ws.[wait_type] like 'WAIT_RBIO[_]%' then 'VLDB RBIO'
        WHEN ws.[wait_type] IN(
            'ASYNC_NETWORK_IO','EXTERNAL_SCRIPT_NETWORK_IOF',
            'NET_WAITFOR_PACKET','PROXY_NETWORK_IO') THEN 'Network IO'
        WHEN ws.[wait_type] IN ( 'CXPACKET', 'CXCONSUMER')
            or ws.[wait_type] like 'HT%' or ws.[wait_type] like 'BMP%'
            or ws.[wait_type] like 'BP%' THEN 'Parallelism'
        WHEN ws.[wait_type] IN(
            'CMEMTHREAD','CMEMPARTITIONED','EE_PMOLOCK','EXCHANGE',
            'RESOURCE_SEMAPHORE','MEMORY_ALLOCATION_EXT',
            'RESERVED_MEMORY_ALLOCATION_EXT', 'MEMORY_GRANT_UPDATE')  THEN 'Memory'
        WHEN ws.[wait_type] IN ('WAITFOR','WAIT_FOR_RESULTS')  THEN 'User Wait'
        WHEN ws.[wait_type] LIKE 'HADR[_]%' or ws.[wait_type] LIKE 'PWAIT_HADR%'
            or ws.[wait_type] LIKE 'REPLICA[_]%' or ws.[wait_type] LIKE 'REPL_%'
            or ws.[wait_type] LIKE 'SE_REPL[_]%'
            or ws.[wait_type] LIKE 'FCB_REPLICA%' THEN 'Replication'
        WHEN ws.[wait_type] LIKE 'SQLTRACE[_]%'
            or ws.[wait_type] IN (
                'TRACEWRITE', 'SQLTRACE_LOCK', 'SQLTRACE_FILE_BUFFER', 'SQLTRACE_FILE_WRITE_IO_COMPLETION',
                'SQLTRACE_FILE_READ_IO_COMPLETION', 'SQLTRACE_PENDING_BUFFER_WRITERS', 'SQLTRACE_SHUTDOWN',
                'QUERY_TRACEOUT', 'TRACE_EVTNOTIF') THEN 'Tracing'
        WHEN ws.[wait_type] IN (
            'FT_RESTART_CRAWL', 'FULLTEXT GATHERER', 'MSSEARCH', 'FT_METADATA_MUTEX',
              'FT_IFTSHC_MUTEX', 'FT_IFTSISM_MUTEX', 'FT_IFTS_RWLOCK', 'FT_COMPROWSET_RWLOCK',
              'FT_MASTER_MERGE', 'FT_PROPERTYLIST_CACHE', 'FT_MASTER_MERGE_COORDINATOR',
              'PWAIT_RESOURCE_SEMAPHORE_FT_PARALLEL_QUERY_SYNC') THEN 'Full Text Search'
         ELSE 'Other'
        END as [wait_category]
          FROM sys.dm_os_wait_stats AS ws WITH (NOLOCK)
          WHERE
        ws.[wait_type] NOT IN (
            N'BROKER_EVENTHANDLER', N'BROKER_RECEIVE_WAITFOR', N'BROKER_TASK_STOP',
            N'BROKER_TO_FLUSH', N'BROKER_TRANSMITTER', N'CHECKPOINT_QUEUE',
            N'CHKPT', N'CLR_AUTO_EVENT', N'CLR_MANUAL_EVENT', N'CLR_SEMAPHORE',
            N'DBMIRROR_DBM_EVENT', N'DBMIRROR_EVENTS_QUEUE', N'DBMIRROR_QUEUE',
            N'DBMIRRORING_CMD', N'DIRTY_PAGE_POLL', N'DISPATCHER_QUEUE_SEMAPHORE',
            N'EXECSYNC', N'FSAGENT', N'FT_IFTS_SCHEDULER_IDLE_WAIT', N'FT_IFTSHC_MUTEX',
            N'HADR_CLUSAPI_CALL', N'HADR_FILESTREAM_IOMGR_IOCOMPLETION', N'HADR_LOGCAPTURE_WAIT',
            N'HADR_NOTIFICATION_DEQUEUE', N'HADR_TIMER_TASK', N'HADR_WORK_QUEUE',
            N'KSOURCE_WAKEUP', N'LAZYWRITER_SLEEP', N'LOGMGR_QUEUE',
            N'MEMORY_ALLOCATION_EXT', N'ONDEMAND_TASK_QUEUE',
            N'PARALLEL_REDO_WORKER_WAIT_WORK',
            N'PREEMPTIVE_HADR_LEASE_MECHANISM', N'PREEMPTIVE_SP_SERVER_DIAGNOSTICS',
            N'PREEMPTIVE_OS_LIBRARYOPS', N'PREEMPTIVE_OS_COMOPS', N'PREEMPTIVE_OS_CRYPTOPS',
            N'PREEMPTIVE_OS_PIPEOPS','PREEMPTIVE_OS_GENERICOPS', N'PREEMPTIVE_OS_VERIFYTRUST',
            N'PREEMPTIVE_OS_DEVICEOPS',
            N'PREEMPTIVE_XE_CALLBACKEXECUTE', N'PREEMPTIVE_XE_DISPATCHER',
            N'PREEMPTIVE_XE_GETTARGETSTATE', N'PREEMPTIVE_XE_SESSIONCOMMIT',
            N'PREEMPTIVE_XE_TARGETINIT', N'PREEMPTIVE_XE_TARGETFINALIZE',
            N'PWAIT_ALL_COMPONENTS_INITIALIZED', N'PWAIT_DIRECTLOGCONSUMER_GETNEXT',
            N'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP',
            N'QDS_ASYNC_QUEUE',
            N'QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP', N'REQUEST_FOR_DEADLOCK_SEARCH',
            N'RESOURCE_QUEUE', N'SERVER_IDLE_CHECK', N'SLEEP_BPOOL_FLUSH', N'SLEEP_DBSTARTUP',
            N'SLEEP_DCOMSTARTUP', N'SLEEP_MASTERDBREADY', N'SLEEP_MASTERMDREADY',
            N'SLEEP_MASTERUPGRADED', N'SLEEP_MSDBSTARTUP', N'SLEEP_SYSTEMTASK', N'SLEEP_TASK',
            N'SLEEP_TEMPDBSTARTUP', N'SNI_HTTP_ACCEPT', N'SP_SERVER_DIAGNOSTICS_SLEEP',
            N'SQLTRACE_BUFFER_FLUSH', N'SQLTRACE_INCREMENTAL_FLUSH_SLEEP',
            N'SQLTRACE_WAIT_ENTRIES',
            N'WAIT_FOR_RESULTS', N'WAITFOR', N'WAITFOR_TASKSHUTDOWN', N'WAIT_XTP_HOST_WAIT',
            N'WAIT_XTP_OFFLINE_CKPT_NEW_LOG', N'WAIT_XTP_CKPT_CLOSE',
            N'XE_BUFFERMGR_ALLPROCESSED_EVENT', N'XE_DISPATCHER_JOIN',
            N'XE_DISPATCHER_WAIT', N'XE_LIVE_TARGET_TVF', N'XE_TIMER_EVENT',
            N'SOS_WORK_DISPATCHER','RESERVED_MEMORY_ALLOCATION_EXT','SQLTRACE_WAIT_ENTRIES',
            N'RBIO_COMM_RETRY')
          AND [waiting_tasks_count] > 10
          AND [wait_time_ms] > 100;

  - query_name: mssql_sess
    query: |
      SELECT TOP 50
          s.login_name                                    AS [username]
          ,r.session_id                                   AS [session_id]
          ,ISNULL(r.blocking_session_id,0)                AS [blocking_session_id]
          ,ISNULL(s.host_name, N'noval')                  AS [hostname]
          ,ISNULL(s.program_name, N'novalue')             AS [program]
          ,ISNULL(r.start_time,0)                         AS [start_time]
          ,ISNULL(r.status,N'novalue')                    AS [status]
          ,ISNULL(r.command,'novalue')                    AS [command]
          ,ISNULL(db_name(r.database_id), N'novalue')     AS [db]
          ,ISNULL(r.wait_time, 0)                         AS [wait_time_ms]
          ,ISNULL(r.wait_type, N'novalue')                AS [wait_type]
          ,ISNULL(r.last_wait_type,N'novalue')            AS [last_wait_type]
          ,ISNULL(r.wait_resource,'novalue')              AS [wait_resource]
          ,ISNULL(r.open_transaction_count,0)             AS [open_transaction_count]
          ,ISNULL(r.transaction_id,0)                     AS [transaction_id]
          ,ISNULL(r.percent_complete,0)                   AS [percent_complete]
          ,ISNULL(r.estimated_completion_time/1000,0)     AS [estimated_completion_time]
          ,ISNULL(r.cpu_time,0)                           AS [cpu_time]
          ,ISNULL(r.total_elapsed_time,0) / (1000.0)      AS [elapsed_sec]
          ,ISNULL(r.reads * 8 / 1024,0)                   AS [physical_read_mb]
          ,ISNULL(r.writes * 8 / 1024,0)                  AS [physical_write_mb]
          ,ISNULL((r.reads + r.writes),0) * 8 / 1024      AS [physical_io_mb]
          ,ISNULL(s.memory_usage,0) * 8192 / 1024         AS [used_menory_kb]
          ,ISNULL(r.logical_reads,0)                      AS [logical_reads]
          ,ISNULL(r.transaction_isolation_level,-1)       AS [transaction_isolation_level]
          ,ISNULL(r.row_count,0)                          AS [row_count]
          ,ISNULL(r.granted_query_memory,0)               AS [granted_query_memory]
          ,ISNULL(CHECKSUM(r.sql_handle), 0)              AS [sql_handle]
          ,SUBSTRING(st.text,0,150)                       AS [statement_text]
      FROM
          sys.dm_exec_sessions s
      CROSS APPLY
          sys.dm_exec_requests r
      CROSS APPLY
          sys.dm_exec_sql_text(r.sql_handle) st
      WHERE
          s.session_id = r.session_id
          AND ISNULL(db_name(r.database_id), N'novalue') <> 'novalue'
          AND ISNULL(db_name(r.database_id), N'novalue') <> 'master'
          AND s.session_id <> @@SPID
          AND s.program_name <> 'go-mssqldb'
      ORDER BY ISNULL(r.cpu_time,0) desc;

  - query_name: mssql_sqls
    query: |
     WITH FilteredQueryStats AS (
        SELECT TOP 300 *
          FROM sys.dm_exec_query_stats
         WHERE last_execution_time BETWEEN DATEADD(second, -600, GETDATE()) 
                                       AND DATEADD(second, 15, GETDATE())
           AND sql_handle IS NOT NULL
         ORDER BY total_elapsed_time DESC
      )
      SELECT DISTINCT
          ISNULL(db_name(qt.dbid), 'NONE') AS [db],
          ISNULL(CHECKSUM(fqs.sql_handle), 0) AS [sql_handle],
          ISNULL(CHECKSUM(fqs.plan_handle), 0) AS [plan_handle],
          fqs.statement_start_offset AS [statement_start_offset],
          SUBSTRING(ISNULL(qt.text, 'NONE'), 0, 150) AS [partial_query],
          ISNULL(fqs.total_elapsed_time, 0) AS [total_elapsed_time_ms],
          ISNULL(fqs.total_worker_time, 0) AS [total_cpu_time_ms],
          ISNULL(fqs.total_physical_reads, 0) AS [total_physical_reads],
          ISNULL(fqs.total_logical_reads, 0) AS [total_logical_reads],
          ISNULL(fqs.total_logical_writes, 0) AS [total_logical_writes],
          ISNULL(fqs.execution_count, 0) AS [execution_count]
      FROM 
          FilteredQueryStats AS fqs
      CROSS APPLY 
          sys.dm_exec_sql_text(fqs.sql_handle) qt;
